name: build, publish and deploy

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag abzy128/abzy-kz:latest
  publish:
    name: Publish
    runs-on: ubuntu-latest
    
    needs: build
    steps:
    - uses: actions/checkout@v4
    - name: Publish the Docker image
      run: docker push abzy128/abzy-kz:latest
  
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    needs: publish
    steps:
      - uses: actions/checkout@v4
      - uses: actions-hub/kubectl@master
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

      - uses: actions-hub/kubectl@master
        with:
          args: apply -f .k8s/deployment.yaml
